<!DOCTYPE html>
<html>
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="game-config.js"></script>
    <script src="game-manager.js"></script>
    <script src="sfx-manager.js"></script>
    <script src="map.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; }
        #menus, #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .menu-box { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 20px; border: 1px solid #0ff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        input, button { padding: 10px; margin: 5px; }
        #pauseOverlay { display: none; position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); padding: 10px; pointer-events: auto; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    
    <div id="menus">
        <div id="main-mp" class="menu-box">
            <h2>MULTIPLAYER</h2>
            <input id="pName" placeholder="Username"><br>
            <button onclick="createRoom()">CREATE LOBBY</button><br>
            <input id="roomCode" placeholder="Enter Code">
            <button onclick="joinRoom()">JOIN LOBBY</button><br>
            <button onclick="location.href='index.html'">BACK</button>
        </div>
        <div id="lobby-ui" class="menu-box" style="display:none;">
            <h2 id="lobby-id"></h2>
            <ul id="p-list" style="text-align:left;"></ul>
            <button id="start-btn" onclick="startGame()" style="display:none;">START MISSION</button>
        </div>
    </div>

    <div id="hud" style="display:none;">
        <div style="position:absolute; top:10px; left:10px;">RINGS: <span id="r-count">0</span> | HP: <span id="hp-count">100</span>%</div>
        <div id="pauseOverlay">
            <h3>PAUSED (AUTOPILOT ON)</h3>
            <button onclick="togglePause()">RESUME</button><br>
            <button onclick="toggleSound()">SOUND</button><br>
            <button onclick="location.href='index.html'">LEAVE</button>
        </div>
    </div>

    <script>
        const socket = io();
        let roomId = null;
        let isHost = false;
        let gameStarted = false;
        
        // 3JS & Game Vars
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 20000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('game-container').appendChild(renderer.domElement);
        
        // Lighting
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444));
        
        let player, peers = {};
        let rings = [], medkits = [];
        let isPaused = false;
        let hp = 100, myRings = 0;
        let isDead = false;

        // --- NETWORK LOBBY ---
        function createRoom() {
            const name = document.getElementById('pName').value || "Pilot";
            socket.emit('create_room', { name });
        }
        function joinRoom() {
            const code = document.getElementById('roomCode').value;
            const name = document.getElementById('pName').value || "Wingman";
            socket.emit('join_room', { roomId: code, name });
        }
        function startGame() { socket.emit('start_game', roomId); }

        socket.on('room_joined', data => {
            roomId = data.roomId;
            isHost = data.isHost;
            MapManager.setSeed(data.seed); // Sync Seed
            document.getElementById('main-mp').style.display = 'none';
            document.getElementById('lobby-ui').style.display = 'block';
            document.getElementById('lobby-id').innerText = "ROOM: " + roomId;
        });

        socket.on('update_lobby', players => {
            const list = document.getElementById('p-list');
            list.innerHTML = players.map(p => `<li>${p.name} ${p.isHost ? '(HOST)':''}</li>`).join('');
            if(isHost) document.getElementById('start-btn').style.display = 'inline-block';
        });

        socket.on('game_started', () => {
            document.getElementById('lobby-ui').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            initGame();
        });
        
        socket.on('player_moved', data => {
            if(!peers[data.id]) {
                const m = new THREE.Mesh(new THREE.ConeGeometry(2, 10, 8), new THREE.MeshStandardMaterial({color: 0xff0000}));
                m.rotateX(Math.PI/2);
                scene.add(m);
                peers[data.id] = m;
            }
            // Interpolate
            peers[data.id].position.lerp(new THREE.Vector3(data.x, data.y, data.z), 0.3);
            peers[data.id].quaternion.slerp(new THREE.Quaternion(data.qx, data.qy, data.qz, data.qw), 0.3);
        });

        socket.on('game_over', data => {
            alert((data.winnerId === socket.id ? "VICTORY!" : "DEFEAT! Winner: " + data.winnerName));
            location.href = 'index.html';
        });

        // --- GAMEPLAY ---
        function initGame() {
            MapManager.generateTerrain(scene);
            const objs = MapManager.generateObjects(scene);
            rings = objs.rings;
            
            const pGeo = new THREE.ConeGeometry(2, 10, 8);
            pGeo.rotateX(Math.PI/2);
            player = new THREE.Mesh(pGeo, new THREE.MeshStandardMaterial({color: 0x00ff00}));
            player.position.set(0, 600, 0);
            scene.add(player);
            gameStarted = true;
            animate();
        }

        // Input
        let keys = {};
        window.addEventListener('keydown', e => {
            if(e.key === 'Escape') togglePause();
            keys[e.key.toLowerCase()] = true;
        });
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseOverlay').style.display = isPaused ? 'block' : 'none';
        }
        function toggleSound() { GameManager.setSfx(!GameManager.state.isSfxOn); }

        function respawn() {
            isDead = true;
            player.visible = false; // Hide plane
            setTimeout(() => {
                player.position.set(0, 600, 0); // Reset to start
                player.rotation.set(0,0,0);
                player.visible = true;
                hp = 100;
                isDead = false;
            }, 3000); // 3s penalty
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameStarted) return;

            if(!isDead) {
                // Movement Logic
                let speed = SKY_CONFIG.NORMAL_SPEED;
                
                if (isPaused) {
                    // Q1 Logic: Autopilot level flight
                    const levelQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, player.rotation.y, 0));
                    player.quaternion.slerp(levelQuat, 0.05); // Smooth level
                } else {
                    // Normal Control
                    if(keys[GameManager.state.bindings.boost]) speed = SKY_CONFIG.BOOST_SPEED;
                    if(keys[GameManager.state.bindings.up]) player.rotateX(SKY_CONFIG.TURN_SPEED);
                    if(keys[GameManager.state.bindings.down]) player.rotateX(-SKY_CONFIG.TURN_SPEED);
                    if(keys[GameManager.state.bindings.left]) player.rotateY(SKY_CONFIG.TURN_SPEED);
                    if(keys[GameManager.state.bindings.right]) player.rotateY(-SKY_CONFIG.TURN_SPEED);
                }
                
                player.translateZ(-speed);

                // Collision
                const gh = MapManager.getTerrainHeight(player.position.x, player.position.z);
                if(player.position.y < gh + 5) {
                    player.position.y = gh + 5;
                    hp -= SKY_CONFIG.TERRAIN_DAMAGE;
                    if(hp <= 0) respawn();
                }

                // Rings
                const nextRing = rings[myRings % SKY_CONFIG.RINGS_TOTAL];
                if(player.position.distanceTo(nextRing.position) < 80) {
                    myRings++;
                    SFXManager.playCollect();
                    socket.emit('finish_lap', { roomId, rings: myRings });
                }
                
                // Network Sync (20 times per sec approx)
                if(Math.random() < 0.2) {
                    socket.emit('update_player', {
                        roomId, 
                        x: player.position.x, y: player.position.y, z: player.position.z,
                        qx: player.quaternion.x, qy: player.quaternion.y, qz: player.quaternion.z, qw: player.quaternion.w
                    });
                }
            }

            // UI
            document.getElementById('r-count').innerText = myRings;
            document.getElementById('hp-count').innerText = Math.floor(hp);

            // Camera
            const camOffset = new THREE.Vector3(0, 30, 80).applyQuaternion(player.quaternion);
            camera.position.lerp(player.position.clone().add(camOffset), 0.1);
            camera.lookAt(player.position);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
