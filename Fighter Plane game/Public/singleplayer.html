<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sky Pilot - Advanced AI</title>
  
  <link rel="icon" href="data:,">

  <!-- THREE.JS LIBRARY -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <!-- ✅ LINKING EXTERNAL CONFIG & MANAGERS -->
  <script src="game-config.js"></script>
  <script src="music-manager.js"></script>
  <script src="sfx-manager.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
    #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 20px; box-sizing: border-box;
    }

    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .left-hud { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
    .right-hud { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: auto; }
    .top-right-row { display: flex; align-items: flex-start; gap: 15px; }

    /* Leaderboard */
    .leaderboard-box {
      background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px;
      color: white; min-width: 220px; pointer-events: none;
      backdrop-filter: blur(4px); border-left: 5px solid #ffd700;
    }
    .lb-title { font-weight: 900; font-size: 14px; color: #ffd700; border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 8px; letter-spacing: 1px; }
    .lb-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px; font-weight: bold; }
    .lb-name { color: #ddd; }
    .lb-score { color: #fff; font-family: monospace; }
    .lb-player { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
    .lb-rank-1 { color: #ffd700; }

    /* Bars */
    .bar-container { width: 220px; text-align: left; pointer-events: none; }
    .right-hud .bar-container { text-align: right; }
    .bar-label { font-weight: 900; font-size: 14px; margin-bottom: 3px; letter-spacing: 1px; text-shadow: 0 0 5px black; }
    .bar-bg { width: 100%; height: 12px; background: rgba(0,0,0,0.6); border: 1px solid #444; border-radius: 6px; overflow: hidden; transform: skewX(-20deg); box-shadow: 0 0 5px rgba(0,210,255,0.5); }
    #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #cc0000, #00ff00); box-shadow: 0 0 10px #00ff00; transition: width 0.1s linear; }
    #boost-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #0066ff, #00d2ff); box-shadow: 0 0 15px #00d2ff; transition: width 0.1s linear; }

    /* FPS */
    #fps-counter { background: rgba(0,0,0,0.5); color: #00ff00; padding: 5px 10px; border-radius: 5px; font-family: monospace; font-weight: bold; font-size: 12px; pointer-events: none; margin-bottom: 5px; }

    /* Pause Button */
    .pause-btn { background: rgba(0,0,0,0.6); color: white; border: 2px solid white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: 0.2s; pointer-events: auto; }
    .pause-btn:hover { background: white; color: black; box-shadow: 0 0 15px white; }

    /* Minimap */
    #minimap-container { position: absolute; bottom: 20px; left: 20px; width: 140px; height: 140px; background: rgba(0,10,30,0.8); border: 2px solid #00d2ff; border-radius: 50%; overflow: hidden; pointer-events: none; box-shadow: 0 0 15px rgba(0,210,255,0.3); }
    #minimap-canvas { width: 100%; height: 100%; }

    /* MOBILE CONTROLS */
    .mobile-controls { display: none; position: absolute; bottom: 20px; width: 100%; padding: 0 20px; box-sizing: border-box; justify-content: space-between; pointer-events: none; z-index: 100; }
    @media (max-width: 1024px) { .mobile-controls { display: flex; } }
    .control-group { pointer-events: auto; display: flex; gap: 10px; }
    .dpad { display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px; gap: 5px; }
    .mob-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; color: white; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; user-select: none; backdrop-filter: blur(4px); }
    .mob-btn:active { background: rgba(0, 210, 255, 0.4); border-color: #00d2ff; transform: scale(0.95); }
    .mob-btn-rect { width: 80px; height: 60px; border-radius: 15px; font-size: 14px; }
    .mob-fire { border-color: #ff4444; } .mob-fire:active { background: rgba(255, 0, 0, 0.3); }
    .mob-boost { border-color: #00d2ff; }
    .btn-up { grid-column: 2; grid-row: 1; } .btn-left { grid-column: 1; grid-row: 2; } .btn-down { grid-column: 2; grid-row: 2; } .btn-right { grid-column: 3; grid-row: 2; }

    /* Screens */
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; z-index: 10; }
    .hidden { display: none !important; }
    .menu-box { background: rgba(12,20,30,0.85); border: 2px solid #00d2ff; border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 0 50px rgba(0,210,255,0.25), inset 0 0 30px rgba(0,210,255,0.1); width: 550px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
    
    h1 { font-size: 56px; color: #fff; text-transform: uppercase; margin: 0 0 10px 0; font-weight: 900; letter-spacing: 4px; text-shadow: 0 0 20px #00d2ff; font-style: italic; }
    .action-btn { display: block; width: 100%; padding: 18px 0; margin: 15px 0; background: linear-gradient(135deg, #00d2ff, #0077ff); border: none; color: #fff; border-radius: 50px; font-size: 20px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 5px 20px rgba(0,210,255,0.4); transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; }
    .action-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 40px rgba(0,210,255,0.6); filter: brightness(1.2); }
    .secondary-btn { background: rgba(255,255,255,0.05); border: 1px solid #555; box-shadow: none; font-size: 16px; }
    .secondary-btn:hover { background: rgba(255,255,255,0.15); border-color: #fff; }
    .win-text { color: #00ff00; font-size: 60px; text-shadow: 0 0 30px #00ff00; font-weight: 900; }
    .lose-text { color: #ff4444; font-size: 60px; text-shadow: 0 0 30px #ff4444; font-weight: 900; }
  </style>
</head>

<body>

  <div id="game-container"></div>

  <div id="ui-layer">
    <div class="hud-top">
      <div class="left-hud">
        <div id="fps-counter">FPS: 0</div>
        <div class="bar-container">
          <div class="bar-label" style="color:#00ff00;">HEALTH</div>
          <div class="bar-bg"><div id="health-fill"></div></div>
        </div>
        <div class="leaderboard-box">
          <div class="lb-title">RACE RANKING</div>
          <div id="leaderboard-list"></div>
        </div>
      </div>

      <div class="right-hud">
        <div class="top-right-row">
          <div class="bar-container">
            <div class="bar-label" style="color:#00d2ff;">BOOST</div>
            <div class="bar-bg"><div id="boost-fill"></div></div>
          </div>
          <div class="pause-btn" onclick="togglePause()">||</div>
        </div>
      </div>
    </div>

    <div id="minimap-container">
      <canvas id="minimap-canvas" width="140" height="140"></canvas>
    </div>

    <!-- MOBILE CONTROLS -->
    <div class="mobile-controls">
        <div class="control-group dpad">
            <div class="mob-btn btn-up" ontouchstart="setAction('up', true)" ontouchend="setAction('up', false)">▲</div>
            <div class="mob-btn btn-left" ontouchstart="setAction('left', true)" ontouchend="setAction('left', false)">◀</div>
            <div class="mob-btn btn-down" ontouchstart="setAction('down', true)" ontouchend="setAction('down', false)">▼</div>
            <div class="mob-btn btn-right" ontouchstart="setAction('right', true)" ontouchend="setAction('right', false)">▶</div>
        </div>
        <div class="control-group" style="flex-direction: column; justify-content: flex-end;">
            <div class="mob-btn mob-btn-rect mob-fire" ontouchstart="setAction('fire', true)" ontouchend="setAction('fire', false)">FIRE</div>
            <div class="mob-btn mob-btn-rect mob-boost" ontouchstart="setAction('boost', true)" ontouchend="setAction('boost', false)">BOOST</div>
        </div>
    </div>
  </div>

  <!-- START SCREEN -->
  <div id="start-screen" class="screen">
    <div class="menu-box">
      <h1>SKY PILOT</h1>
      <p style="color:#00d2ff; letter-spacing:1px; margin-bottom:20px;">SINGLEPLAYER MISSION</p>
      <button class="action-btn" onclick="startSinglePlayer()">LAUNCH MISSION</button>
      <button class="action-btn secondary-btn" onclick="window.location.href='index.html'">BACK TO MENU</button>
    </div>
  </div>

  <!-- PAUSE -->
  <div id="pause-screen" class="screen hidden">
    <div class="menu-box">
      <h1>PAUSED</h1>
      <button class="action-btn" onclick="togglePause()">RESUME FLIGHT</button>
      <button class="action-btn secondary-btn" style="border-color:#ff4444; color:#ff4444;" onclick="location.reload()">ABORT MISSION</button>
    </div>
  </div>

  <!-- END -->
  <div id="end-screen" class="screen hidden">
    <div class="menu-box">
      <h1 id="end-title" class="win-text">VICTORY</h1>
      <p id="end-msg" style="color:#fff; font-size: 20px;">Rank 1 Secured.</p>
      <button class="action-btn" onclick="location.reload()">RE-ENGAGE</button>
    </div>
  </div>

<script>
  document.body.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

  // ✅ 1) SETTINGS & BINDINGS FIX (Shift=Boost, Space=Fire)
  let isMusicOn = localStorage.getItem('skyPilot_music') !== 'OFF';
  let isSoundOn = localStorage.getItem('skyPilot_sfx') !== 'OFF';
  let bindings = { up: 'w', down: 's', left: 'a', right: 'd', boost: 'shift', fire: ' ' };
  const savedBinds = localStorage.getItem('skyPilot_bindings');
  if (savedBinds) { try { Object.assign(bindings, JSON.parse(savedBinds)); } catch(e){} }

  // --- GAME STATE ---
  let scene, camera, renderer, planeRig, planeMesh, guideArrow;
  let enemies = [], repairKits = [], rings = [], ringWaypoints = [];
  let currentRingObj = null, bullets = [], isPlaying = false, isPaused = false;
  let boostLevel = 100, health = 100, lastFireTime = 0;
  let lastRender = performance.now(); 
  let playerPrevPos = new THREE.Vector3(), playerVelocity = new THREE.Vector3();
  let playerStats = { name: "PLAYER", rings: 0, progress: 0 };
  let enemyStats = [{ name: "ACE", rings: 0, obj: null }, { name: "VIPER", rings: 0, obj: null }, { name: "GHOST", rings: 0, obj: null }, { name: "HAWK", rings: 0, obj: null }];
  let enemiesAliveCount = 4;
  const activeKeys = {}; let visualRoll = 0, visualPitch = 0;
  let lastFrameTime = performance.now(), frameCount = 0;
  const fpsElem = document.getElementById('fps-counter');
  const minimapCtx = document.getElementById('minimap-canvas').getContext('2d');
  
  // ✅ FIX 5: Optimized temp vector for distance checks
  const TMP_VEC = new THREE.Vector3();

  // ✅ HELPERS
  function setAction(action, state) { activeKeys[action] = state; }
  function isActionActive(actionId) { return !!activeKeys[actionId]; }

  // ✅ INPUT LISTENERS (Logical Mapping)
  window.addEventListener('keydown', (e) => {
    if(e.key === "Escape") { togglePause(); return; }
    if(isPaused) return;
    const k = e.key.toLowerCase();
    if(k === bindings.up || k === 'arrowup') setAction('up', true);
    if(k === bindings.down || k === 'arrowdown') setAction('down', true);
    if(k === bindings.left || k === 'arrowleft') setAction('left', true);
    if(k === bindings.right || k === 'arrowright') setAction('right', true);
    if(k === bindings.boost || (bindings.boost === 'shift' && (e.code === 'ShiftLeft' || e.code === 'ShiftRight'))) setAction('boost', true);
    if(k === bindings.fire || (bindings.fire === ' ' && e.code === 'Space')) setAction('fire', true);
  });

  window.addEventListener('keyup', (e) => {
    const k = e.key.toLowerCase();
    if(k === bindings.up || k === 'arrowup') setAction('up', false);
    if(k === bindings.down || k === 'arrowdown') setAction('down', false);
    if(k === bindings.left || k === 'arrowleft') setAction('left', false);
    if(k === bindings.right || k === 'arrowright') setAction('right', false);
    if(k === bindings.boost || (bindings.boost === 'shift' && (e.code === 'ShiftLeft' || e.code === 'ShiftRight'))) setAction('boost', false);
    if(k === bindings.fire || (bindings.fire === ' ' && e.code === 'Space')) setAction('fire', false);
  });

  // ✅ UI LOGIC
  function updateLeaderboard() {
    const list = document.getElementById('leaderboard-list'); if(!list) return; list.innerHTML = "";
    let racers = [playerStats, ...enemyStats].filter(r => r.name === "PLAYER" || (r.obj && r.obj.userData.alive));
    racers.forEach(r => { if(r.name !== "PLAYER" && r.obj) r.rings = r.obj.userData.progress; });
    racers.sort((a, b) => b.rings - a.rings);
    racers.forEach((r, i) => {
      const row = document.createElement("div"); row.className = "lb-row";
      const n = document.createElement("span"); n.className = "lb-name"; if(r.name === "PLAYER") n.classList.add("lb-player"); if(i === 0) n.classList.add("lb-rank-1"); n.innerText = `${i+1}. ${r.name}`;
      const s = document.createElement("span"); s.className = "lb-score"; s.innerText = `${r.rings}/${TOTAL_RINGS_WIN}`;
      row.appendChild(n); row.appendChild(s); list.appendChild(row);
    });
  }

  function togglePause() {
    if(!isPlaying) return; isPaused = !isPaused;
    const pauseScreen = document.getElementById('pause-screen');
    if(isPaused) pauseScreen.classList.remove('hidden'); 
    else { pauseScreen.classList.add('hidden'); lastRender = performance.now(); requestAnimationFrame(animate); }
  }

  // ✅ GAME START
  function startSinglePlayer() { 
      MusicManager.init();
      SFXManager.init();
      if (isMusicOn) MusicManager.playLobby(); 
      initGame(); 
  }

  function initGame() {
    if (typeof TERRAIN_COLORS === 'undefined') { alert("CRITICAL ERROR: game-config.js not loaded!"); return; }
    document.getElementById('start-screen').classList.add('hidden');
    const container = document.getElementById('game-container');
    if (scene) scene.clear();
    rings = []; repairKits = []; enemies = []; bullets = []; ringWaypoints = [];
    
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB); scene.fog = new THREE.Fog(0x87CEEB, 2000, 10000);
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 20000);
    renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); 
    container.innerHTML = ''; container.appendChild(renderer.domElement);
    
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); scene.add(hemiLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(100, 200, 50); scene.add(dirLight);
    
    playerStats.rings = 0; playerStats.progress = 0; health = 100; boostLevel = 100;
    generateTerrain(); generateOcean(); createPlaneSystem(); createGuideArrow(); createRepairKits(); createRings(); createEnemies();
    updateRingVisuals(); updateLeaderboard();
    
    if (isMusicOn) MusicManager.updateGameplayMusic(health);
    isPlaying = true; isPaused = false; lastRender = performance.now(); animate();
  }

  // --- BUILDERS ---
  function getTerrainHeight(x, z) { let y = Math.sin(x * 0.001) * Math.cos(z * 0.001) * 1000 + Math.sin(x * 0.005) * 200; if (z > -1000 && z < 1000 && x > -1000 && x < 1000) y *= 0.1; if (y < -150) y = -150; return y - 50; }
  function generateTerrain() { const geometry = new THREE.PlaneGeometry(50000, 50000, 100, 100); geometry.rotateX(-Math.PI / 2); const pos = geometry.attributes.position; const colors = []; for (let i = 0; i < pos.count; i++) { let y = getTerrainHeight(pos.getX(i), pos.getZ(i)); pos.setY(i, y); const c = new THREE.Color(); if (y < 100) c.setHex(TERRAIN_COLORS.SAND); else if (y < 500) c.setHex(TERRAIN_COLORS.GRASS); else c.setHex(TERRAIN_COLORS.ROCK); colors.push(c.r, c.g, c.b); } geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3)); geometry.computeVertexNormals(); const mesh = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ vertexColors: true, roughness: 0.8, flatShading: true })); mesh.position.y = -50; scene.add(mesh); }
  function generateOcean() { const geo = new THREE.PlaneGeometry(50000, 50000); geo.rotateX(-Math.PI / 2); scene.add(new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ color: TERRAIN_COLORS.WATER, transparent: true, opacity: 0.6 }))); }
  function createPlaneMesh(color) { 
    const group = new THREE.Group(); 
    const mat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.4 }); 
    const nose = new THREE.Mesh(new THREE.ConeGeometry(2, 10, 8), mat); nose.rotateX(-Math.PI/2); nose.position.z = -20; 
    const body = new THREE.Mesh(new THREE.CylinderGeometry(2, 4, 30, 8), mat); body.rotateX(-Math.PI/2); 
    const lWing = new THREE.Mesh(new THREE.BoxGeometry(20, 0.5, 15), mat); lWing.position.set(-10, 0, 5); 
    group.add(body, nose, lWing); 
    const rWing = lWing.clone(); rWing.position.x = 10; 
    group.add(rWing); return group; 
  }
  function createPlaneSystem() { planeRig = new THREE.Group(); planeRig.position.set(0, 400, 800); scene.add(planeRig); planeMesh = createPlaneMesh(0x555555); planeRig.add(planeMesh); }
  function createEnemies() { for(let i=0; i<4; i++) { const enemy = new THREE.Group(); const mesh = createPlaneMesh(0xaa0000); enemy.add(mesh); enemy.position.set((i - 1.5) * 200, 400, 400); enemy.name = enemyStats[i].name; enemy.userData = { alive: true, health: 300, progress: 0, lastShot: 0 }; scene.add(enemy); enemies.push(enemy); enemyStats[i].obj = enemy; } }
  function createGuideArrow() { guideArrow = new THREE.Group(); guideArrow.add(new THREE.Mesh(new THREE.ConeGeometry(4, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00ff00 }))); scene.add(guideArrow); }
  function createRings() { for(let i=0; i<RINGS_PER_LAP; i++) { const a = i * (Math.PI * 2 / RINGS_PER_LAP); const x = Math.sin(a) * 12000, z = Math.cos(a) * -12000; ringWaypoints.push({x, y: Math.max(500, getTerrainHeight(x, z)+400), z}); const r = new THREE.Mesh(new THREE.TorusGeometry(80, 10, 16, 50), new THREE.MeshPhongMaterial({ color: 0xFFD700, emissive: 0xffaa00 })); r.position.set(x, ringWaypoints[i].y, z); scene.add(r); rings.push(r); } }
  function updateRingVisuals() { const cur = playerStats.progress % RINGS_PER_LAP; rings.forEach((r, i) => r.visible = (i === cur)); if(rings[cur]) currentRingObj = rings[cur]; }
  function createRepairKits() { const box = new THREE.Mesh(new THREE.BoxGeometry(60, 60, 60), new THREE.MeshPhongMaterial({ color: 0x00aa00 })); [{ x: 1000, z: -3000 }, { x: -2000, z: -6000 }].forEach((loc) => { const k = box.clone(); k.position.set(loc.x, 400, loc.z); k.userData = { active: true, respawnTime: 0 }; scene.add(k); repairKits.push(k); }); }

  // ✅ ACTION FUNCTIONS
  function spawnBullet() {
    SFXManager.playGun(isSoundOn);
    const bullet = new THREE.Mesh(new THREE.SphereGeometry(2, 8, 8), new THREE.MeshBasicMaterial({ color: 0xffaa00 })); 
    bullet.position.copy(planeRig.position); scene.add(bullet);
    const v = new THREE.Vector3(0,0,-1).applyQuaternion(planeRig.quaternion).multiplyScalar(8000); 
    bullets.push({ mesh: bullet, velocity: v, life: 1.5, isEnemy: false });
  }

  function spawnEnemyBullet(enemy, targetPos) { 
    SFXManager.playGun(isSoundOn);
    const bullet = new THREE.Mesh(new THREE.SphereGeometry(4, 8, 8), new THREE.MeshBasicMaterial({ color: 0xff0000 })); 
    bullet.position.copy(enemy.position); scene.add(bullet); 
    const v = new THREE.Vector3().subVectors(targetPos, enemy.position).normalize().multiplyScalar(4000); 
    bullets.push({ mesh: bullet, velocity: v, life: 2.0, isEnemy: true, owner: enemy }); 
  }

  function ringCollected(collectorName) {
    SFXManager.playRing(isSoundOn);
    if (collectorName === "PLAYER") {
      playerStats.rings++; playerStats.progress++; updateRingVisuals();
      if (playerStats.rings >= TOTAL_RINGS_WIN) endGame(true, "Champion!");
    } else {
      const eStat = enemyStats.find(e => e.name === collectorName);
      if(eStat) { eStat.rings++; if(eStat.rings >= TOTAL_RINGS_WIN) endGame(false, `${eStat.name} Won!`); }
    }
    updateLeaderboard();
  }

  // ✅ MAIN LOOP
  function animate() {
    if (!isPlaying || isPaused) return; 
    const nowPerf = performance.now();
    const dt = Math.min((nowPerf - lastRender) / 1000, 0.05); lastRender = nowPerf;
    
    frameCount++; if (nowPerf - lastFrameTime >= 1000) { fpsElem.innerText = "FPS: " + frameCount; frameCount = 0; lastFrameTime = nowPerf; }
    const now = Date.now();

    // ✅ FIX: Optimized Music logic
    if (isMusicOn) MusicManager.updateGameplayMusic(health); 
    else if (MusicManager.currentTheme !== null) MusicManager.stop();

    const isBoosting = isActionActive('boost') && boostLevel > 0;
    SFXManager.updateContinuous(isBoosting, health < 30, isSoundOn);

    // ✅ FIX: Firing Trigger
    if (isActionActive('fire') && now - lastFireTime > FIRE_RATE) { lastFireTime = now; spawnBullet(); }

    // ✅ FIX: DT Based Player Physics
    let spd = (isBoosting ? BOOST_SPEED : NORMAL_SPEED) * dt * 60;
    if (isBoosting) boostLevel -= BOOST_DRAIN * dt * 60; else boostLevel = Math.min(100, boostLevel + BOOST_REFILL * dt * 60);
    boostLevel = THREE.MathUtils.clamp(boostLevel, 0, 100);
    document.getElementById('boost-fill').style.width = boostLevel + '%';
    planeRig.translateZ(-spd);
    
    if (isActionActive('left')) planeRig.rotation.y += TURN_SPEED * dt * 60;
    else if (isActionActive('right')) planeRig.rotation.y -= TURN_SPEED * dt * 60;
    
    if (isActionActive('up')) planeRig.position.y += LIFT_SPEED * dt * 60;
    else if (isActionActive('down')) planeRig.position.y -= LIFT_SPEED * dt * 60;

    // AI Logic (DT Based)
    enemies.forEach(e => {
        if(!e.userData.alive) return;
        const targetWp = ringWaypoints[e.userData.progress % RINGS_PER_LAP];
        e.lookAt(targetWp.x, targetWp.y, targetWp.z);
        e.translateZ(-NORMAL_SPEED * dt * 60);
        // Optimized distance check
        TMP_VEC.set(targetWp.x, targetWp.y, targetWp.z);
        if(e.position.distanceTo(TMP_VEC) < 200) { e.userData.progress++; ringCollected(e.name); }
        if(e.position.distanceTo(planeRig.position) < 2000 && now - e.userData.lastShot > 3000) { spawnEnemyBullet(e, planeRig.position); e.userData.lastShot = now; }
    });

    // Bullets Physics
    for (let i = bullets.length - 1; i >= 0; i--) {
      const b = bullets[i]; b.mesh.position.addScaledVector(b.velocity, dt); b.life -= dt;
      if (b.life <= 0) { scene.remove(b.mesh); bullets.splice(i, 1); continue; }
      if (b.isEnemy && b.mesh.position.distanceTo(planeRig.position) < 80) {
          health -= 10; SFXManager.playExplosion(isSoundOn); scene.remove(b.mesh); bullets.splice(i, 1);
          if(health <= 0) endGame(false, "Shot Down!"); continue;
      }
    }

    document.getElementById('health-fill').style.width = health + '%';
    const targetCam = new THREE.Vector3(0, 100, 300).applyMatrix4(planeRig.matrixWorld);
    camera.position.lerp(targetCam, 0.1); camera.lookAt(planeRig.position);
    
    if (currentRingObj && planeRig.position.distanceTo(currentRingObj.position) < 150) ringCollected("PLAYER");

    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }

  function endGame(win, reason) { isPlaying = false; SFXManager.stopAll(); if(win) MusicManager.playWin(); else MusicManager.playLose(); const s = document.getElementById('end-screen'); s.classList.remove('hidden'); document.getElementById('end-title').innerText = win ? "VICTORY" : "DEFEAT"; document.getElementById('end-msg').innerText = reason; }
  window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
</script>
</body>
</html>
