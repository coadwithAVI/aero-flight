<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sky Pilot - Advanced AI</title>
    
    <script src="game-config.js"></script>
    <script src="sfx-manager.js"></script>
    <script src="music-manager.js"></script>
    <script src="game-manager.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; }
        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .left-hud, .right-hud { display: flex; flex-direction: column; gap: 10px; }
        .bar-container { width: 220px; }
        .bar-bg { width: 100%; height: 12px; background: rgba(0,0,0,0.6); border: 1px solid #444; border-radius: 6px; overflow: hidden; transform: skewX(-20deg); }
        #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #cc0000, #00ff00); }
        #boost-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #0066ff, #00d2ff); }
        .leaderboard-box { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; color: white; min-width: 220px; border-left: 5px solid #ffd700; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: auto; }
        .menu-box { background: rgba(12,20,30,0.9); border: 2px solid #00d2ff; border-radius: 20px; padding: 40px; text-align: center; width: 450px; }
        .hidden { display: none !important; }
        .action-btn { display: block; width: 100%; padding: 18px 0; margin: 15px 0; background: linear-gradient(135deg, #00d2ff, #0077ff); border: none; color: #fff; border-radius: 50px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="game-container"></div>

<div id="ui-layer">
    <div class="hud-top">
        <div class="left-hud">
            <div id="fps-counter" style="color:#00ff00; font-family:monospace;">FPS: 0</div>
            <div class="bar-container">
                <div style="color:#00ff00; font-weight:900; font-size:12px;">HEALTH</div>
                <div class="bar-bg"><div id="health-fill"></div></div>
            </div>
            <div class="leaderboard-box">
                <div style="font-weight:900; color:#ffd700; margin-bottom:5px;">RACE RANKING</div>
                <div id="leaderboard-list"></div>
            </div>
        </div>
        <div class="right-hud">
            <div class="bar-container" style="text-align:right;">
                <div style="color:#00d2ff; font-weight:900; font-size:12px;">BOOST</div>
                <div class="bar-bg"><div id="boost-fill"></div></div>
            </div>
            <div style="pointer-events:auto; cursor:pointer; color:white; border:1px solid white; padding:5px 10px;" onclick="togglePause()">PAUSE</div>
        </div>
    </div>
</div>

<div id="start-screen" class="screen">
    <div class="menu-box">
        <h1 style="color:white; letter-spacing:4px;">SKY PILOT</h1>
        <p style="color:#00d2ff;">ADVANCED AI MISSION</p>
        <button class="action-btn" onclick="initGame()">LAUNCH MISSION</button>
        <button class="action-btn" style="background:#444;" onclick="window.location.href='index.html'">BACK</button>
    </div>
</div>

<div id="pause-screen" class="screen hidden">
    <div class="menu-box">
        <h1 style="color:white;">PAUSED</h1>
        <button class="action-btn" onclick="togglePause()">RESUME</button>
        <button class="action-btn" style="background:#cc0000;" onclick="location.reload()">ABORT</button>
    </div>
</div>

<div id="end-screen" class="screen hidden">
    <div class="menu-box">
        <h1 id="end-title" style="font-size:48px; font-weight:900;"></h1>
        <p id="end-msg" style="color:white; font-size:18px;"></p>
        <button class="action-btn" onclick="location.reload()">RE-ENGAGE</button>
    </div>
</div>

<script>
    const CONFIG = window.SKY_CONFIG;
    let scene, camera, renderer, planeRig, planeMesh;
    let enemies = [], rings = [], repairKits = [], bullets = [], ringWaypoints = [];
    let isPlaying = false, isPaused = false;
    let health = 100, boostLevel = 100;
    let playerStats = { name: "PLAYER", rings: 0, progress: 0 };
    let playerPrevPos = new THREE.Vector3(), playerVelocity = new THREE.Vector3();
    let lastFireTime = 0, frameCount = 0, lastFrameTime = performance.now();
    const activeKeys = {};

    // --- ðŸŒ TERRAIN HEIGHT LOGIC (Original Function) ---
    function getTerrainHeight(x, z) {
        let y = Math.sin(x * 0.001) * Math.cos(z * 0.001) * 1000 + Math.sin(x * 0.005) * 200;
        if (z > -1000 && z < 1000 && x > -1000 && x < 1000) y *= 0.1; 
        if (y < -150) y = -150; 
        return y - 50;
    }

    // --- âœˆï¸ PLANE MESH (Original Model) ---
    function createPlaneMesh(color) {
        const group = new THREE.Group();
        const mat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.4 });
        const body = new THREE.Mesh(new THREE.CylinderGeometry(2, 4, 30, 8), mat);
        body.rotateX(-Math.PI/2);
        const nose = new THREE.Mesh(new THREE.ConeGeometry(2, 10, 8), mat);
        nose.rotateX(-Math.PI/2); nose.position.z = -20;
        const lWing = new THREE.Mesh(new THREE.BoxGeometry(20, 0.5, 15), mat);
        lWing.position.set(-10, 0, 5);
        const rWing = lWing.clone(); rWing.position.set(10, 0, 5);
        group.add(body, nose, lWing, rWing);
        return group;
    }

    function initGame() {
        document.getElementById('start-screen').classList.add('hidden');
        MusicManager.init(); SFXManager.init();

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 2000, 10000);

        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 20000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('game-container').appendChild(renderer.domElement);

        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6); scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(100, 200, 50); scene.add(dirLight);

        createPlayer();
        createTerrain();
        createRings();
        createEnemies();
        
        isPlaying = true;
        animate();
    }

    function createPlayer() {
        planeRig = new THREE.Group();
        planeRig.position.set(0, 400, 800);
        scene.add(planeRig);
        planeMesh = createPlaneMesh(0x555555);
        planeRig.add(planeMesh);
    }

    function createTerrain() {
        const geometry = new THREE.PlaneGeometry(50000, 50000, 100, 100);
        geometry.rotateX(-Math.PI / 2);
        const positions = geometry.attributes.position;
        for (let i = 0; i < positions.count; i++) {
            positions.setY(i, getTerrainHeight(positions.getX(i), positions.getZ(i)));
        }
        geometry.computeVertexNormals();
        const mat = new THREE.MeshStandardMaterial({ color: CONFIG.TERRAIN_COLORS.GRASS, flatShading: true });
        const mesh = new THREE.Mesh(geometry, mat);
        mesh.position.y = -50;
        scene.add(mesh);
    }

    function createRings() {
        for(let i=0; i<CONFIG.RINGS_PER_LAP; i++) {
            const angle = (i / CONFIG.RINGS_PER_LAP) * Math.PI * 2;
            const x = Math.sin(angle) * 8000;
            const z = Math.cos(angle) * -8000;
            const y = Math.max(400, getTerrainHeight(x, z) + 400);
            ringWaypoints.push({x, y, z});
            const ring = new THREE.Mesh(new THREE.TorusGeometry(80, 10, 16, 50), new THREE.MeshPhongMaterial({ color: 0xFFD700 }));
            ring.position.set(x, y, z);
            ring.visible = (i === 0);
            rings.push(ring);
            scene.add(ring);
        }
    }

    function createEnemies() {
        const names = ["ACE", "VIPER", "GHOST"];
        names.forEach((name, i) => {
            const enemy = new THREE.Group();
            enemy.add(createPlaneMesh(0xaa0000));
            enemy.position.set((i-1)*300, 400, 400);
            enemy.userData = { 
                name: name, alive: true, health: 100, progress: 0, state: "RACE",
                ai: { aggression: 0.5 + Math.random()*0.5, aim: 0.7 + Math.random()*0.3 }
            };
            enemies.push(enemy);
            scene.add(enemy);
        });
    }

    // --- ðŸ§  AI LOGIC: LEAD AIM & STATE MACHINE ---
    function calculateLeadAim(shooterPos, target, bulletSpeed) {
        const dist = shooterPos.distanceTo(target.position);
        const time = dist / bulletSpeed;
        return target.position.clone().add(playerVelocity.clone().multiplyScalar(time));
    }

    function animate() {
        if (!isPlaying || isPaused) return;
        requestAnimationFrame(animate);

        const now = performance.now();
        frameCount++;
        if (now - lastFrameTime >= 1000) {
            document.getElementById('fps-counter').innerText = "FPS: " + frameCount;
            frameCount = 0; lastFrameTime = now;
        }

        // Velocity Tracking
        playerVelocity.subVectors(planeRig.position, playerPrevPos);
        playerPrevPos.copy(planeRig.position);

        updatePlayer();
        updateEnemies();
        updateBullets();
        
        renderer.render(scene, camera);
    }

    function updatePlayer() {
        const speed = (isActionActive('boost') && boostLevel > 0) ? CONFIG.BOOST_SPEED : CONFIG.NORMAL_SPEED;
        planeRig.translateZ(-speed);

        if (isActionActive('left')) planeRig.rotation.y += CONFIG.TURN_SPEED;
        if (isActionActive('right')) planeRig.rotation.y -= CONFIG.TURN_SPEED;
        if (isActionActive('up')) planeRig.position.y += CONFIG.LIFT_SPEED;
        if (isActionActive('down')) planeRig.position.y -= CONFIG.LIFT_SPEED;

        // Collision & SFX
        const gh = getTerrainHeight(planeRig.position.x, planeRig.position.z);
        let isDamaging = planeRig.position.y < gh + 20;
        if (isDamaging) health -= CONFIG.COLLISION_DAMAGE * 0.1;
        
        SFXManager.updateContinuous(isActionActive('boost'), isDamaging, GameManager.data.sfx);
        MusicManager.updateGameplayMusic(health);

        document.getElementById('health-fill').style.width = health + '%';
        
        // Ring logic
        const targetRing = rings[playerStats.progress % CONFIG.RINGS_PER_LAP];
        if (planeRig.position.distanceTo(targetRing.position) < 150) {
            targetRing.visible = false;
            playerStats.progress++;
            SFXManager.playRing(GameManager.data.sfx);
            if (playerStats.progress >= CONFIG.TOTAL_RINGS_WIN) endGame(true, "Champion!");
            else rings[playerStats.progress % CONFIG.RINGS_PER_LAP].visible = true;
        }

        const camTarget = new THREE.Vector3(0, 60, 200).applyMatrix4(planeRig.matrixWorld);
        camera.position.lerp(camTarget, 0.1);
        camera.lookAt(planeRig.position);
    }

    function updateEnemies() {
        enemies.forEach(e => {
            if (!e.userData.alive) return;
            const wp = ringWaypoints[e.userData.progress % CONFIG.RINGS_PER_LAP];
            const targetPos = new THREE.Vector3(wp.x, wp.y, wp.z);
            
            // Steering
            const dummy = new THREE.Object3D();
            dummy.position.copy(e.position);
            dummy.lookAt(targetPos);
            e.quaternion.slerp(dummy.quaternion, 0.03);
            e.translateZ(-CONFIG.NORMAL_SPEED * 0.95);

            if (e.position.distanceTo(targetPos) < 200) e.userData.progress++;

            // Firing logic
            if (Math.random() < 0.01 && e.position.distanceTo(planeRig.position) < 3000) {
                spawnBullet(e, calculateLeadAim(e.position, planeRig, 20), true);
            }
        });
    }

    function spawnBullet(owner, targetPos, isEnemy) {
        const b = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshBasicMaterial({ color: isEnemy ? 0xff0000 : 0xffff00 }));
        b.position.copy(owner.position);
        const dir = targetPos.clone().sub(owner.position).normalize();
        bullets.push({ mesh: b, vel: dir.multiplyScalar(20), life: 200, isEnemy });
        scene.add(b);
        if(!isEnemy) SFXManager.playGun(GameManager.data.sfx);
    }

    function updateBullets() {
        for (let i = bullets.length - 1; i >= 0; i--) {
            const b = bullets[i];
            b.mesh.position.add(b.vel);
            b.life--;
            if (b.life <= 0) { scene.remove(b.mesh); bullets.splice(i, 1); continue; }

            if (b.isEnemy && b.mesh.position.distanceTo(planeRig.position) < 50) {
                health -= 10; scene.remove(b.mesh); bullets.splice(i, 1);
                SFXManager.playExplosion(GameManager.data.sfx);
            }
        }
    }

    function isActionActive(a) { return activeKeys[GameManager.data.bindings[a]]; }
    window.addEventListener('keydown', e => activeKeys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => activeKeys[e.key.toLowerCase()] = false);
    
    function togglePause() { 
        isPaused = !isPaused; 
        document.getElementById('pause-screen').classList.toggle('hidden', !isPaused);
        if (!isPaused) animate();
    }

    function endGame(win, msg) {
        isPlaying = false;
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-title').innerText = win ? "VICTORY" : "DEFEAT";
        document.getElementById('end-msg').innerText = msg;
        if(win) MusicManager.playWin(); else MusicManager.playLose();
    }
</script>
</body>
</html>
