<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="game-config.js"></script>
    <script src="game-manager.js"></script>
    <script src="sfx-manager.js"></script>
    <script src="music-manager.js"></script>
    <script src="map.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; font-family: monospace; }
        #pauseMenu { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px; text-align: center; border: 2px solid white; color: white; }
    </style>
</head>
<body>
    <div id="ui">RINGS: 0 | HP: 100% | LAP: 1</div>
    <div id="pauseMenu">
        <h1>PAUSED</h1>
        <button onclick="togglePause()">RESUME</button><br>
        <button onclick="toggleSound()">TOGGLE SOUND</button><br>
        <button onclick="location.href='index.html'">ABORT MISSION</button>
    </div>
    
    <script>
        // Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(SKY_CONFIG.COLORS.SKY);
        scene.fog = new THREE.Fog(SKY_CONFIG.COLORS.SKY, 1000, 15000);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 20000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lighting
        const hemi = new THREE.HemisphereLight(0xffffff, 0x444444);
        scene.add(hemi);
        const dir = new THREE.DirectionalLight(0xffffff);
        dir.position.set(100, 200, 100);
        scene.add(dir);

        // Game State
        let player, terrain;
        let rings = [], medkits = [];
        let bullets = [];
        let bots = [];
        let keys = {};
        let stats = { hp: 100, rings: 0, lap: 1, boost: 100 };
        let isPaused = false;
        let gameActive = true;

        // Init
        MapManager.generateTerrain(scene);
        const mapData = MapManager.generateObjects(scene);
        rings = mapData.rings;
        medkits = mapData.medkits;

        // Player Plane
        const pGeo = new THREE.ConeGeometry(2, 10, 8);
        pGeo.rotateX(Math.PI/2);
        const pMat = new THREE.MeshStandardMaterial({ color: 0x00d2ff });
        player = new THREE.Mesh(pGeo, pMat);
        player.position.set(0, 600, 0);
        scene.add(player);

        // Bots
        for(let i=0; i<4; i++) {
            const bot = new THREE.Mesh(pGeo, new THREE.MeshStandardMaterial({color: 0xff0000}));
            bot.position.set(i*50 - 100, 600, 0);
            bot.userData = { speed: SKY_CONFIG.NORMAL_SPEED * (0.9 + Math.random()*0.2), nextRing: 0 };
            scene.add(bot);
            bots.push(bot);
        }

        // Inputs
        window.addEventListener('keydown', e => {
            if(e.key === 'Escape') togglePause();
            keys[e.key.toLowerCase()] = true;
            if(keys[GameManager.state.bindings.fire] && !isPaused) fireBullet();
        });
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseMenu').style.display = isPaused ? 'block' : 'none';
        }
        
        function toggleSound() {
            GameManager.setSfx(!GameManager.state.isSfxOn);
        }

        function fireBullet() {
            SFXManager.playFire();
            const b = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color:0xffff00}));
            b.position.copy(player.position);
            b.quaternion.copy(player.quaternion);
            scene.add(b);
            bullets.push({ mesh: b, life: 100 });
        }

        function update() {
            if(isPaused || !gameActive) return;

            // 1. Player Movement
            let speed = keys[GameManager.state.bindings.boost] && stats.boost > 0 ? SKY_CONFIG.BOOST_SPEED : SKY_CONFIG.NORMAL_SPEED;
            if(speed > SKY_CONFIG.NORMAL_SPEED) stats.boost -= SKY_CONFIG.BOOST_DRAIN;
            else stats.boost = Math.min(100, stats.boost + SKY_CONFIG.BOOST_REFILL);

            if(keys[GameManager.state.bindings.up]) player.rotateX(SKY_CONFIG.TURN_SPEED);
            if(keys[GameManager.state.bindings.down]) player.rotateX(-SKY_CONFIG.TURN_SPEED);
            if(keys[GameManager.state.bindings.left]) player.rotateY(SKY_CONFIG.TURN_SPEED);
            if(keys[GameManager.state.bindings.right]) player.rotateY(-SKY_CONFIG.TURN_SPEED);

            player.translateZ(-speed);

            // 2. Terrain Collision (Slow Drain)
            const groundH = MapManager.getTerrainHeight(player.position.x, player.position.z);
            if (player.position.y < groundH + 5) {
                player.position.y = groundH + 5; // Slide on top
                stats.hp -= SKY_CONFIG.TERRAIN_DAMAGE;
                if(stats.hp <= 0) gameOver(false);
            }

            // 3. Rings & Medkits
            const nextRingIdx = stats.rings % SKY_CONFIG.RINGS_TOTAL;
            const targetRing = rings[nextRingIdx];
            if(player.position.distanceTo(targetRing.position) < 80) {
                SFXManager.playCollect();
                stats.rings++;
                targetRing.visible = false; // Hide collected
                if(stats.rings >= SKY_CONFIG.RINGS_TOTAL * SKY_CONFIG.LAPS) gameOver(true);
            }

            medkits.forEach(k => {
                if(k.userData.active && player.position.distanceTo(k.position) < 50) {
                    stats.hp = Math.min(100, stats.hp + SKY_CONFIG.MEDKIT_HEAL);
                    k.visible = false;
                    k.userData.active = false;
                    SFXManager.playCollect();
                }
            });

            // 4. Bots AI (Simple: Look at next ring and move)
            bots.forEach(bot => {
                const ring = rings[bot.userData.nextRing % SKY_CONFIG.RINGS_TOTAL];
                bot.lookAt(ring.position);
                bot.translateZ(-bot.userData.speed);
                if(bot.position.distanceTo(ring.position) < 80) {
                    bot.userData.nextRing++;
                    if(bot.userData.nextRing >= SKY_CONFIG.RINGS_TOTAL * SKY_CONFIG.LAPS) gameOver(false); // Bot won
                }
            });

            // 5. Bullets
            bullets.forEach((b, i) => {
                b.mesh.translateZ(-SKY_CONFIG.BULLET_SPEED);
                b.life--;
                if(b.life <= 0) { scene.remove(b.mesh); bullets.splice(i, 1); }
            });

            // UI
            document.getElementById('ui').innerHTML = `RINGS: ${stats.rings}/${SKY_CONFIG.RINGS_TOTAL*SKY_CONFIG.LAPS} | HP: ${Math.floor(stats.hp)}% | BOOST: ${Math.floor(stats.boost)}`;
            
            // Camera Follow
            const camOffset = new THREE.Vector3(0, 30, 80).applyQuaternion(player.quaternion);
            camera.position.lerp(player.position.clone().add(camOffset), 0.1);
            camera.lookAt(player.position);
        }

        function gameOver(win) {
            gameActive = false;
            alert(win ? "VICTORY!" : "DEFEAT!");
            location.href = 'index.html';
        }

        function loop() {
            requestAnimationFrame(loop);
            update();
            renderer.render(scene, camera);
        }
        loop();
    </script>
</body>
</html>
