<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sky Pilot - Singleplayer</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script src="game-config.js"></script>
  <script src="game-manager.js"></script>
  <script src="map.js"></script>
  <script src="sfx-manager.js"></script>
  <script src="music-manager.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
    #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 20px; box-sizing: border-box;
    }

    .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
    .left-hud { display: flex; flex-direction: column; align-items: flex-start; gap: 15px; }
    .right-hud { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: auto; }

    .leaderboard-box {
      background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px;
      color: white; min-width: 220px; backdrop-filter: blur(4px); border-left: 5px solid #ffd700;
    }
    .lb-title { font-weight: 900; font-size: 14px; color: #ffd700; border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 8px; letter-spacing: 1px; }
    .lb-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 4px; font-weight: bold; }
    .lb-player { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
    .lb-rank-1 { color: #ffd700; }

    .bar-container { width: 220px; text-align: left; }
    .bar-bg { width: 100%; height: 12px; background: rgba(0,0,0,0.6); border: 1px solid #444; border-radius: 6px; overflow: hidden; transform: skewX(-20deg); }
    #health-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #cc0000, #00ff00); transition: width 0.1s linear; }
    #boost-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #0066ff, #00d2ff); transition: width 0.1s linear; }

    #fps-counter { background: rgba(0,0,0,0.5); color: #00ff00; padding: 5px 10px; border-radius: 5px; font-family: monospace; font-size: 12px; }
    .pause-btn { background: rgba(0,0,0,0.6); color: white; border: 2px solid white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; }

    #minimap-container { position: absolute; bottom: 20px; left: 20px; width: 140px; height: 140px; background: rgba(0,10,30,0.8); border: 2px solid #00d2ff; border-radius: 50%; overflow: hidden; }
    #minimap-canvas { width: 100%; height: 100%; }

    /* ORIGINAL MOBILE CONTROLS */
    .mobile-controls { display: none; position: absolute; bottom: 20px; width: 100%; padding: 0 20px; box-sizing: border-box; justify-content: space-between; pointer-events: none; }
    @media (max-width: 1024px) { .mobile-controls { display: flex; } }
    .control-group { pointer-events: auto; display: flex; gap: 10px; }
    .dpad { display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px; gap: 5px; }
    .mob-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; user-select: none; }
    .mob-btn:active { background: rgba(0, 210, 255, 0.4); }
    .mob-btn-rect { width: 80px; height: 60px; border-radius: 15px; }
    .btn-up { grid-column: 2; grid-row: 1; } .btn-left { grid-column: 1; grid-row: 2; } .btn-down { grid-column: 2; grid-row: 2; } .btn-right { grid-column: 3; grid-row: 2; }

    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: auto; }
    .hidden { display: none !important; }
    .menu-box { background: rgba(15,25,35,0.9); border: 2px solid #00d2ff; border-radius: 20px; padding: 40px; text-align: center; width: 450px; }
    .action-btn { display: block; width: 100%; padding: 15px; margin: 15px 0; background: linear-gradient(135deg, #00d2ff, #0077ff); border: none; color: white; border-radius: 30px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
    .secondary-btn { background: rgba(255,255,255,0.1); border: 1px solid #555; }
    .win-text { color: #00ff00; font-size: 50px; font-weight: 900; }
    .lose-text { color: #ff4444; font-size: 50px; font-weight: 900; }
  </style>
</head>
<body>

  <div id="game-container"></div>

  <div id="ui-layer">
    <div class="hud-top">
      <div class="left-hud">
        <div id="fps-counter">FPS: 0</div>
        <div class="bar-container">
          <div style="color:#00ff00; font-size:12px; margin-bottom:3px;">HEALTH</div>
          <div class="bar-bg"><div id="health-fill"></div></div>
        </div>
        <div class="leaderboard-box">
          <div class="lb-title">MISSION RANKING</div>
          <div id="leaderboard-list"></div>
        </div>
      </div>
      <div class="right-hud">
        <div style="display:flex; gap:15px; align-items:flex-start;">
          <div class="bar-container">
            <div style="color:#00d2ff; font-size:12px; margin-bottom:3px; text-align:right;">BOOST</div>
            <div class="bar-bg"><div id="boost-fill"></div></div>
          </div>
          <div class="pause-btn" onclick="togglePause()">||</div>
        </div>
      </div>
    </div>
    <div id="minimap-container"><canvas id="minimap-canvas" width="140" height="140"></canvas></div>
    
    <div class="mobile-controls">
        <div class="control-group dpad">
            <div class="mob-btn btn-up" ontouchstart="setKey('up', true)" ontouchend="setKey('up', false)" ontouchcancel="setKey('up', false)">▲</div>
            <div class="mob-btn btn-left" ontouchstart="setKey('left', true)" ontouchend="setKey('left', false)" ontouchcancel="setKey('left', false)">◀</div>
            <div class="mob-btn btn-down" ontouchstart="setKey('down', true)" ontouchend="setKey('down', false)" ontouchcancel="setKey('down', false)">▼</div>
            <div class="mob-btn btn-right" ontouchstart="setKey('right', true)" ontouchend="setKey('right', false)" ontouchcancel="setKey('right', false)">▶</div>
        </div>
        <div class="control-group" style="flex-direction: column; justify-content: flex-end;">
            <div class="mob-btn mob-btn-rect" style="border-color:#ff4444;" ontouchstart="setKey('fire', true)" ontouchend="setKey('fire', false)" ontouchcancel="setKey('fire', false)">FIRE</div>
            <div class="mob-btn mob-btn-rect" style="border-color:#00d2ff;" ontouchstart="setKey('boost', true)" ontouchend="setKey('boost', false)" ontouchcancel="setKey('boost', false)">BOOST</div>
        </div>
    </div>
  </div>

  <div id="start-screen" class="screen">
    <div class="menu-box">
      <h1 style="color:white; font-size:40px; margin-bottom:10px;">SKY PILOT</h1>
      <p style="color:#00d2ff; margin-bottom:30px;">SOLO CAMPAIGN</p>
      <button class="action-btn" onclick="startSinglePlayer()">START ENGINE</button>
      <button class="action-btn secondary-btn" onclick="window.location.href='index.html'">BACK</button>
    </div>
  </div>

  <div id="pause-screen" class="screen hidden">
    <div class="menu-box">
      <h1 style="color:white;">PAUSED</h1>
      <button class="action-btn" onclick="togglePause()">RESUME</button>
      <button class="action-btn secondary-btn" onclick="location.reload()">RESTART</button>
    </div>
  </div>

  <div id="end-screen" class="screen hidden">
    <div class="menu-box">
      <h1 id="end-title" class="win-text">VICTORY</h1>
      <p id="end-msg" style="color:white; font-size:18px;">Mission Accomplished.</p>
      <button class="action-btn" onclick="location.reload()">PLAY AGAIN</button>
      <button class="action-btn secondary-btn" onclick="window.location.href='index.html'">MAIN MENU</button>
    </div>
  </div>

<script>
  // --- CONFIG (As per your request) ---
  const Cfg = window.SKY_CONFIG || {};
  // Overriding configured rings for Singleplayer specific request
  const RINGS_PER_LAP = 4;
  const TOTAL_RINGS_WIN = 8; 

  // --- GLOBALS ---
  let scene, camera, renderer, planeRig, planeMesh, guideArrow;
  let terrainMesh, oceanMesh;
  let rings = [], ringWaypoints = [], enemies = [], bullets = [];
  let isPlaying = false, isPaused = false;
  let currentRingObj = null;

  // Stats
  let health = 100, boostLevel = 100;
  let playerStats = { name: "PLAYER", rings: 0, progress: 0 };
  let enemiesAliveCount = 4;
  let playerLastRingIndex = -1; // To prevent double counting
  let enemyStats = [
      { name: "ACE", rings: 0, obj: null }, 
      { name: "VIPER", rings: 0, obj: null }, 
      { name: "GHOST", rings: 0, obj: null }, 
      { name: "HAWK", rings: 0, obj: null }
  ];

  // Logic Vars
  let lastFireTime = 0;
  let lastCrashTime = 0;
  let visualRoll = 0, visualPitch = 0;
  let miniTick = 0;
  
  // Framerate independence attempt (basic)
  let lastTime = performance.now();
  let frameCount = 0;
  const fpsElem = document.getElementById('fps-counter');
  const minimapCtx = document.getElementById('minimap-canvas').getContext('2d');
  
  // Controls
  const activeKeys = {};

  // --- AUDIO FIX ---
  // Music logic ko start button par move kiya hai
  function initAudio() {
      if(window.MusicManager) {
          MusicManager.init();
          MusicManager.playCombat(); // Playing Combat music for race
      }
      if(window.SFXManager) {
          SFXManager.init();
      }
  }

  // --- INPUT HANDLING (YOUR ORIGINAL LOGIC) ---
  function getBindings() {
      if (window.GameManager && window.GameManager.data && window.GameManager.data.bindings) return window.GameManager.data.bindings;
      return { up:'w', down:'s', left:'a', right:'d', boost:' ', fire:'shift' };
  }
  
  function setKey(action, state) { 
      const binds = getBindings();
      if(action === "boost") { activeKeys[binds.boost] = state; activeKeys["Space"] = state; return; }
      if(action === "fire") { activeKeys[binds.fire] = state; activeKeys["shift"] = state; activeKeys["Shift"] = state; return; }
      activeKeys[binds[action]] = state;
  }
  
  window.addEventListener('keydown', (e) => {
      if(e.key === "Escape") { togglePause(); return; }
      const binds = getBindings(); const k = e.key.toLowerCase();
      if(k === binds.up || k === 'arrowup') activeKeys[binds.up] = true;
      if(k === binds.down || k === 'arrowdown') activeKeys[binds.down] = true;
      if(k === binds.left || k === 'arrowleft') activeKeys[binds.left] = true;
      if(k === binds.right || k === 'arrowright') activeKeys[binds.right] = true;
      if(k === binds.boost || (binds.boost === ' ' && e.code === 'Space')) activeKeys[binds.boost] = true;
      if(k === binds.fire || (binds.fire === 'shift' && (e.code === 'ShiftLeft' || e.code === 'ShiftRight'))) activeKeys[binds.fire] = true;
  });
  
  window.addEventListener('keyup', (e) => {
      const binds = getBindings(); const k = e.key.toLowerCase();
      if(k === binds.up || k === 'arrowup') activeKeys[binds.up] = false;
      if(k === binds.down || k === 'arrowdown') activeKeys[binds.down] = false;
      if(k === binds.left || k === 'arrowleft') activeKeys[binds.left] = false;
      if(k === binds.right || k === 'arrowright') activeKeys[binds.right] = false;
      if(k === binds.boost || (binds.boost === ' ' && e.code === 'Space')) activeKeys[binds.boost] = false;
      if(k === binds.fire || (binds.fire === 'shift' && (e.code === 'ShiftLeft' || e.code === 'ShiftRight'))) activeKeys[binds.fire] = false;
  });
  
  function isActionActive(id) { 
      const binds = getBindings();
      if(id === 'boost') return activeKeys[binds.boost] || activeKeys[" "] || activeKeys["Space"];
      if(id === 'fire') return activeKeys[binds.fire] || activeKeys["shift"] || activeKeys["Shift"];
      return activeKeys[binds[id]] || activeKeys['arrow'+id]; 
  }

  // --- TOUCH SCROLL LOCK ---
  function preventTouch(e) { e.preventDefault(); }
  function lockTouchScroll() { document.body.addEventListener("touchmove", preventTouch, { passive: false }); }
  function unlockTouchScroll() { document.body.removeEventListener("touchmove", preventTouch); }

  // --- GAME START ---
  window.startSinglePlayer = function() {
      initAudio(); // Activate Audio Context
      initGame();
  }

  function initGame() {
    lockTouchScroll();
    document.getElementById('start-screen').classList.add('hidden');
    const container = document.getElementById('game-container');
    
    // Cleanup logic
    if(renderer) { renderer.dispose(); container.innerHTML = ''; }
    
    // Scene Setup
    scene = new THREE.Scene(); 
    scene.background = new THREE.Color(0x87CEEB); 
    scene.fog = new THREE.Fog(0x87CEEB, 2000, 15000);
    
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 15000);
    renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1));
    container.appendChild(renderer.domElement);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.6));
    const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(100, 200, 50); scene.add(dl);

    // Map Generation (Using MapManager)
    // NOTE: Generating specific ring count (4 per lap)
    terrainMesh = MapManager.generateTerrain(Cfg); scene.add(terrainMesh);
    oceanMesh = MapManager.generateOcean(Cfg); scene.add(oceanMesh);
    
    // Pass RINGS_PER_LAP here
    const ringData = MapManager.generateRings(RINGS_PER_LAP); 
    rings = ringData.rings; 
    ringWaypoints = ringData.waypoints;
    rings.forEach(r => scene.add(r));

    // Reset Stats
    playerStats = { name: "PLAYER", rings: 0, progress: 0 };
    enemyStats.forEach(e => e.rings = 0);
    health = 100; boostLevel = 100;
    
    createPlaneSystem();
    createGuideArrow();
    createEnemies(); // 4 Enemies
    updateRingVisuals();
    updateLeaderboard();

    isPlaying = true; isPaused = false;
    animate();
  }

  // --- CREATION FUNCTIONS ---
  function createPlaneMesh(color) {
      const g = new THREE.Group(); 
      const mat = new THREE.MeshStandardMaterial({ color, roughness: 0.4 });
      const body = new THREE.Mesh(new THREE.CylinderGeometry(2, 4, 30, 8), mat); body.rotateX(-Math.PI/2);
      const nose = new THREE.Mesh(new THREE.ConeGeometry(2, 10, 8), mat); nose.rotateX(-Math.PI/2); nose.position.z = -20;
      const wings = new THREE.Mesh(new THREE.BoxGeometry(20, 0.5, 10), mat); wings.position.set(0, 0, 5);
      g.add(body, nose, wings); 
      return g;
  }

  function createPlaneSystem() { 
      planeRig = new THREE.Group(); 
      planeRig.position.set(0, 400, 800); // Start Pos
      scene.add(planeRig); 
      planeMesh = createPlaneMesh(0x555555); 
      planeRig.add(planeMesh); 
      
      const glow = new THREE.Mesh(new THREE.ConeGeometry(3, 10, 8), new THREE.MeshBasicMaterial({ color: 0x00d2ff, transparent: true, opacity: 0 }));
      glow.rotateX(Math.PI/2); glow.position.z = 20; glow.name = "EngineGlow"; planeMesh.add(glow); 
  }

  function createGuideArrow() { 
      guideArrow = new THREE.Group(); 
      guideArrow.add(new THREE.Mesh(new THREE.ConeGeometry(4, 10, 8), new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent:true, opacity:0.8 }))); 
      guideArrow.children[0].rotateX(Math.PI/2); 
      scene.add(guideArrow); 
  }

  // --- ENEMY AI (ORIGINAL - NO CHANGES) ---
  function createEnemies() {
      enemies = [];
      for(let i=0; i<4; i++) { 
          const e = new THREE.Group(); 
          e.add(createPlaneMesh(0xaa0000)); 
          // Start positions staggered
          e.position.set((i - 1.5) * 200, 400, 400); 
          e.name = enemyStats[i].name;
          // Simple AI Stats
          e.userData = { 
              alive: true, health: 300, 
              speed: Cfg.NORMAL_SPEED || 5, 
              progress: 0, 
              lastRingIndex: -1 
          }; 
          scene.add(e); 
          enemies.push(e); 
          enemyStats[i].obj = e; 
      }
  }

  function spawnBullet(isPlayer, origin, quat) {
      if(window.SFXManager && isPlayer) SFXManager.playGun(true);
      
      const geo = new THREE.SphereGeometry(isPlayer ? 2 : 4, 8, 8);
      const mat = new THREE.MeshBasicMaterial({ color: isPlayer ? 0xffaa00 : 0xff0000 });
      const bullet = new THREE.Mesh(geo, mat);
      
      bullet.position.copy(origin);
      // Speed multiplier logic
      const speed = isPlayer ? 25 : 40; 
      const v = new THREE.Vector3(0,0,-1).applyQuaternion(quat).multiplyScalar(speed);
      
      bullets.push({ mesh: bullet, velocity: v, life: 100, isPlayer: isPlayer });
      scene.add(bullet);
  }

  // --- GAME LOOP ---
  function animate() {
    if(!isPlaying || isPaused) return;
    
    // FPS Calc
    const now = performance.now();
    frameCount++;
    if(now - lastTime >= 1000) { fpsElem.innerText = "FPS: " + frameCount; frameCount = 0; lastTime = now; }

    // 1. Player Movement (Original Logic)
    let spd = isActionActive('boost') && boostLevel > 0 ? (Cfg.BOOST_SPEED || 10) : (Cfg.NORMAL_SPEED || 5);
    
    if(isActionActive('boost') && boostLevel > 0) { 
        boostLevel -= 0.5; 
        planeMesh.getObjectByName("EngineGlow").material.opacity = 0.8; 
    } else { 
        boostLevel = Math.min(100, boostLevel + 0.1); 
        planeMesh.getObjectByName("EngineGlow").material.opacity = 0; 
    }
    document.getElementById('boost-fill').style.width = boostLevel + '%';

    planeRig.translateZ(-spd);

    if(isActionActive('left')) { planeRig.rotation.y += 0.03; visualRoll = THREE.MathUtils.lerp(visualRoll, 0.8, 0.1); }
    else if(isActionActive('right')) { planeRig.rotation.y -= 0.03; visualRoll = THREE.MathUtils.lerp(visualRoll, -0.8, 0.1); }
    else visualRoll = THREE.MathUtils.lerp(visualRoll, 0, 0.1);
    
    if(isActionActive('up')) { planeRig.position.y += 5; visualPitch = THREE.MathUtils.lerp(visualPitch, -0.4, 0.1); }
    else if(isActionActive('down')) { planeRig.position.y -= 5; visualPitch = THREE.MathUtils.lerp(visualPitch, 0.4, 0.1); }
    else visualPitch = THREE.MathUtils.lerp(visualPitch, 0, 0.1);

    planeMesh.rotation.z = visualRoll; 
    planeMesh.rotation.x = visualPitch;

    // Player Shooting
    if(isActionActive('fire') && Date.now() - lastFireTime > 150) {
        spawnBullet(true, planeRig.position, planeRig.quaternion);
        lastFireTime = Date.now();
    }

    // Camera
    const ct = new THREE.Vector3(0, 100, 300).applyMatrix4(planeRig.matrixWorld); 
    camera.position.lerp(ct, 0.1); 
    camera.lookAt(planeRig.position);

    // 2. Enemy AI (ORIGINAL LOGIC - NO RAYCASTING)
    enemies.forEach(e => {
        if(!e.userData.alive) return;
        
        // Find current target ring
        const targetRingIndex = e.userData.progress % RINGS_PER_LAP;
        const wp = ringWaypoints[targetRingIndex];
        
        if(wp) {
            const target = new THREE.Vector3(wp.x, wp.y, wp.z);
            // Simple LookAt and Move
            const dummy = new THREE.Object3D(); 
            dummy.position.copy(e.position); 
            dummy.lookAt(target); 
            // Fix orientation (Model was rotated X -90)
            dummy.rotateY(Math.PI); 
            
            e.quaternion.slerp(dummy.quaternion, 0.03); 
            e.translateZ(-e.userData.speed);

            // Simple Floor Clamp (Original behavior)
            const h = MapManager.getTerrainHeight(e.position.x, e.position.z);
            if(e.position.y < h + 50) e.position.y = h + 50;

            // Check Ring Collection for AI
            if(e.position.distanceTo(target) < 200 && e.userData.lastRingIndex !== targetRingIndex) {
                e.userData.lastRingIndex = targetRingIndex;
                e.userData.progress++;
                enemyRingCollected(e.name);
            }
        }
    });

    // 3. Bullets & Collisions
    for(let i=bullets.length-1; i>=0; i--) {
        const b = bullets[i];
        b.mesh.position.add(b.velocity);
        b.life--;
        
        if(b.life <= 0) { scene.remove(b.mesh); bullets.splice(i,1); continue; }
        
        // Simple hit check (Player hitting Enemy)
        if(b.isPlayer) {
            enemies.forEach(e => {
                if(e.userData.alive && b.mesh.position.distanceTo(e.position) < 100) {
                    // Hit logic
                    scene.remove(b.mesh); bullets.splice(i,1);
                    // No visual damage for now, just cleanup
                }
            });
        }
    }

    // 4. Player Terrain Collision
    const ph = MapManager.getTerrainHeight(planeRig.position.x, planeRig.position.z);
    if(planeRig.position.y < ph + 20) {
        planeRig.position.y = ph + 20;
        health -= 0.5; // Damage on drag
        if(window.SFXManager && Math.random() > 0.9) SFXManager.playExplosion();
        if(health <= 0) endGame(false, "CRASHED");
    }
    document.getElementById('health-fill').style.width = health + '%';

    // 5. Player Ring Collection
    const currentTargetIndex = playerStats.progress % RINGS_PER_LAP;
    const playerTargetObj = rings[currentTargetIndex];
    
    updateRingVisuals(currentTargetIndex);
    
    if(playerTargetObj) {
        guideArrow.visible = true;
        guideArrow.position.copy(planeRig.position).y += 60;
        guideArrow.lookAt(playerTargetObj.position);
        
        if(planeRig.position.distanceTo(playerTargetObj.position) < 150) {
             // Sequence Check
             if (playerLastRingIndex !== currentTargetIndex) {
                 playerLastRingIndex = currentTargetIndex;
                 playerStats.progress++;
                 playerStats.rings++;
                 
                 if(window.SFXManager) SFXManager.playRing(true);
                 
                 // Win Check
                 if(playerStats.rings >= TOTAL_RINGS_WIN) {
                     endGame(true, "CHAMPION!");
                 }
                 updateLeaderboard();
             }
        }
    }

    // Minimap
    miniTick++; if(miniTick > 5) { drawMinimap(); miniTick=0; }
    
    requestAnimationFrame(animate);
  }

  // --- HELPERS ---
  function enemyRingCollected(name) {
      const e = enemyStats.find(x => x.name === name);
      if(e) e.rings++;
      
      // Check Enemy Win
      if(e.rings >= TOTAL_RINGS_WIN) {
          endGame(false, `${name} WON THE RACE!`);
      }
      updateLeaderboard();
  }

  function updateRingVisuals(currIdx) {
      rings.forEach((r, i) => {
          if(i === currIdx) { 
              r.material.emissive.setHex(0xffaa00); 
              r.visible = true; 
          } else { 
              r.visible = true; // Keep all visible or hide based on preference
              r.material.emissive.setHex(0x000000);
          }
      });
  }

  function updateLeaderboard() {
      const list = document.getElementById('leaderboard-list'); 
      if(!list) return; 
      list.innerHTML = "";
      
      let racers = [playerStats, ...enemyStats];
      // Map enemy object rings to stat rings
      racers.forEach(r => {
          if(r.name !== "PLAYER" && r.obj) {
              // using the stat object we tracked in enemyRingCollected
          }
      });
      
      racers.sort((a, b) => b.rings - a.rings);
      
      racers.forEach((r, i) => {
          const row = document.createElement("div"); row.className = "lb-row";
          if(r.name === "PLAYER") row.classList.add("lb-player");
          if(i === 0) row.classList.add("lb-rank-1");
          row.innerHTML = `<span>${i+1}. ${r.name}</span><span>${r.rings}/${TOTAL_RINGS_WIN}</span>`;
          list.appendChild(row);
      });
  }

  function drawMinimap() {
      if(!minimapCtx || !planeRig) return;
      minimapCtx.clearRect(0,0,140,140);
      const cx=70, cy=70, scale=60/5000;
      
      minimapCtx.save();
      minimapCtx.translate(cx,cy);
      minimapCtx.rotate(-planeRig.rotation.y+Math.PI);
      
      // Player Dot
      minimapCtx.beginPath();
      minimapCtx.moveTo(0,-6); minimapCtx.lineTo(-4,4); minimapCtx.lineTo(4,4);
      minimapCtx.fillStyle="#00ff00"; minimapCtx.fill();
      minimapCtx.restore();
      
      // Enemies
      enemies.forEach(e => {
          if(!e.userData.alive) return;
          const dx=(e.position.x-planeRig.position.x)*scale;
          const dz=(e.position.z-planeRig.position.z)*scale;
          minimapCtx.beginPath(); 
          minimapCtx.arc(cx+dx, cy+dz, 3, 0, Math.PI*2);
          minimapCtx.fillStyle="#ff0000"; minimapCtx.fill();
      });
      
      // Target Ring
      const tidx = playerStats.progress % RINGS_PER_LAP;
      if(rings[tidx]) {
          const r = rings[tidx];
          const dx=(r.position.x-planeRig.position.x)*scale;
          const dz=(r.position.z-planeRig.position.z)*scale;
          minimapCtx.beginPath(); 
          minimapCtx.arc(cx+dx, cy+dz, 4, 0, Math.PI*2);
          minimapCtx.fillStyle="#ffd700"; minimapCtx.fill();
      }
  }

  function togglePause() { 
      if(!isPlaying) return; 
      isPaused = !isPaused; 
      document.getElementById('pause-screen').classList.toggle('hidden', !isPaused); 
      if(!isPaused) requestAnimationFrame(animate); 
  }

  function endGame(win, msg) {
      isPlaying = false;
      unlockTouchScroll();
      if(window.MusicManager) MusicManager.stop();
      if(window.SFXManager && win) SFXManager.playRing(); 
      
      const s = document.getElementById('end-screen');
      s.classList.remove('hidden');
      document.getElementById('end-title').innerText = win ? "VICTORY" : "DEFEAT";
      document.getElementById('end-title').className = win ? "win-text" : "lose-text";
      document.getElementById('end-msg').innerText = msg;
  }
  
  window.addEventListener('resize', () => { 
      camera.aspect = window.innerWidth/window.innerHeight; 
      camera.updateProjectionMatrix(); 
      renderer.setSize(window.innerWidth, window.innerHeight); 
  });
</script>
</body>
</html>
