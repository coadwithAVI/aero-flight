<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky Pilot: Solo Mission</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script src="game-config.js"></script>
    <script src="game-manager.js"></script>
    <script src="map.js"></script>
    <script src="sfx-manager.js"></script>
    <script src="music-manager.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* HUD */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .hud-panel { position: absolute; padding: 10px; pointer-events: auto; }
        .top-left { top: 20px; left: 20px; }
        .top-right { top: 20px; right: 20px; text-align: right; }
        
        .stat-bar { width: 200px; height: 10px; background: rgba(0,0,0,0.5); border: 1px solid #555; transform: skewX(-20deg); margin-top: 5px; overflow: hidden; }
        .fill-bar { height: 100%; width: 100%; transition: width 0.1s linear; }
        .health-fill { background: linear-gradient(90deg, #ff4444, #ff0000); box-shadow: 0 0 10px #ff0000; }
        .boost-fill { background: linear-gradient(90deg, #00d2ff, #0088ff); box-shadow: 0 0 10px #00d2ff; }
        .text-glow { color: #fff; text-shadow: 0 0 5px #00d2ff; font-weight: bold; font-size: 14px; letter-spacing: 1px; }

        /* LEADERBOARD */
        .leaderboard { background: rgba(0,0,0,0.6); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; color: #ccc; }
        .lb-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .lb-you { color: #ffd700; font-weight: bold; }

        /* SCREENS */
        .screen { 
            position: absolute; width: 100%; height: 100%; 
            background: rgba(10, 15, 20, 0.9); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; transition: opacity 0.3s; pointer-events: auto;
        }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }
        .menu-box { 
            background: rgba(0, 0, 0, 0.8); border: 2px solid #00d2ff; padding: 40px; 
            border-radius: 10px; text-align: center; box-shadow: 0 0 30px rgba(0, 210, 255, 0.2); 
        }
        button {
            background: linear-gradient(180deg, #00d2ff, #0077ff); border: none;
            padding: 15px 40px; margin: 10px; color: white; font-weight: bold;
            font-size: 18px; cursor: pointer; transform: skewX(-10deg);
            box-shadow: 0 5px 15px rgba(0, 119, 255, 0.4);
        }
        button:hover { transform: skewX(-10deg) scale(1.05); filter: brightness(1.2); }

        /* MOBILE CONTROLS */
        .mobile-controls { display: none; position: absolute; bottom: 20px; width: 100%; height: 120px; z-index: 15; pointer-events: none; }
        @media (max-width: 1024px) { .mobile-controls { display: flex; justify-content: space-between; padding: 0 20px; } }
        .touch-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; pointer-events: auto; backdrop-filter: blur(4px); }
        .touch-btn:active { background: rgba(0, 210, 255, 0.5); }
    </style>
</head>
<body>

    <div id="game-canvas"></div>

    <div id="ui-layer" class="hidden">
        <div class="hud-panel top-left">
            <div class="text-glow">HULL INTEGRITY</div>
            <div class="stat-bar"><div id="health-bar" class="fill-bar health-fill"></div></div>
            <br>
            <div class="text-glow">RINGS: <span id="score-text" style="color:#ffd700">0/12</span></div>
            
            <div class="leaderboard">
                <div style="border-bottom:1px solid #555; margin-bottom:5px;">RANKING</div>
                <div id="lb-content"></div>
            </div>
        </div>

        <div class="hud-panel top-right">
            <div style="text-align:right">
                <div class="text-glow">THRUST</div>
                <div class="stat-bar"><div id="boost-bar" class="fill-bar boost-fill"></div></div>
            </div>
            <button style="padding:5px 15px; font-size:12px; height:40px; margin-top:10px;" onclick="Game.end(false)">ABORT</button>
        </div>

        <div class="mobile-controls">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; width: 160px; pointer-events: auto;">
                <div></div><div class="touch-btn" id="btn-up"></div><div></div>
                <div class="touch-btn" id="btn-left"></div><div class="touch-btn" id="btn-down"></div><div class="touch-btn" id="btn-right"></div>
            </div>
            <div style="display:flex; gap:10px; align-items:flex-end; pointer-events: auto;">
                <div class="touch-btn" id="btn-boost" style="border-color:#00d2ff"></div>
            </div>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="menu-box">
            <h1 class="text-glow" style="font-size:50px;">SKY PILOT</h1>
            <p style="color:#00d2ff; letter-spacing:2px; margin-bottom:30px;">SOLO CAMPAIGN</p>
            <button onclick="Game.start()">ENGAGE</button>
            <br>
            <button style="background:none; border:1px solid #555; font-size:14px;" onclick="window.location.href='index.html'">BACK TO MENU</button>
        </div>
    </div>

    <div id="end-screen" class="screen hidden">
        <div class="menu-box">
            <h1 id="end-title" style="font-size:50px;">VICTORY</h1>
            <p id="end-reason" style="color:white;">Rank #1</p>
            <button onclick="location.reload()">REPLAY</button>
            <br>
            <button style="background:none; border:1px solid #555;" onclick="window.location.href='index.html'">MAIN MENU</button>
        </div>
    </div>

<script>
/**
 * ðŸŽ® SKY PILOT: SINGLEPLAYER (Smart AI Edition)
 * Features: Terrain Avoidance AI, Delta Time Physics, Performance Optimization
 */

const Game = {
    scene: null, camera: null, renderer: null,
    plane: null, terrain: null, ocean: null,
    clock: new THREE.Clock(),
    isPlaying: false,

    // Game Objects
    rings: [],
    enemies: [], // AI Bots
    
    // Player State
    pos: new THREE.Vector3(0, 600, 0),
    speed: 0,
    health: 100,
    boost: 100,
    ringsCollected: 0,
    keys: { up:0, down:0, left:0, right:0, boost:0 },

    init: function() {
        // Renderer Setup
        this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        document.getElementById('game-canvas').appendChild(this.renderer.domElement);

        // Scene
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(SKY_CONFIG.TERRAIN_COLORS.SKY);
        this.scene.fog = new THREE.FogExp2(SKY_CONFIG.TERRAIN_COLORS.SKY, SKY_CONFIG.FOG_DENSITY);

        // Camera
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 10000);

        // Lights
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
        this.scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(500, 1000, 500);
        this.scene.add(dirLight);

        this.setupInputs();
    },

    start: function() {
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden');

        // 1. Generate World
        MapManager.setSeed(Math.random() * 10000); // Random world for solo
        this.terrain = MapManager.generateTerrain(SKY_CONFIG);
        this.scene.add(this.terrain);
        this.scene.add(MapManager.generateOcean(SKY_CONFIG));

        // 2. Generate Rings
        const rData = MapManager.generateRings(SKY_CONFIG.RINGS_PER_LAP, SKY_CONFIG);
        this.rings = rData.rings;
        this.rings.forEach(r => this.scene.add(r));

        // 3. Player
        this.createPlayer();

        // 4. Create Smart AI
        this.createEnemies(3); // 3 Bots

        // 5. Audio
        if(window.MusicManager) {
            MusicManager.init();
            MusicManager.playLobby(); // Reusing ambient track
        }
        if(window.SFXManager) SFXManager.init();

        this.isPlaying = true;
        this.animate();
    },

    createPlayer: function() {
        const geo = new THREE.ConeGeometry(2, 10, 8);
        geo.rotateX(Math.PI / 2);
        const mat = new THREE.MeshStandardMaterial({ color: 0x00d2ff, roughness: 0.2, metalness: 0.8 });
        this.plane = new THREE.Mesh(geo, mat);
        this.scene.add(this.plane);
        this.pos.set(0, 600, 0);
        this.plane.position.copy(this.pos);
        this.speed = SKY_CONFIG.NORMAL_SPEED;
    },

    createEnemies: function(count) {
        const names = ["Viper", "Ghost", "Ace"];
        const colors = [0xff0000, 0xffaa00, 0x8800ff];

        for(let i=0; i<count; i++) {
            const geo = new THREE.ConeGeometry(2, 10, 8);
            geo.rotateX(Math.PI / 2);
            const mat = new THREE.MeshStandardMaterial({ color: colors[i] });
            const mesh = new THREE.Mesh(geo, mat);
            
            // Spawn slightly behind player
            mesh.position.set((i-1)*100, 600, 100); 

            this.enemies.push({
                name: names[i],
                mesh: mesh,
                speed: SKY_CONFIG.NORMAL_SPEED * (0.9 + Math.random() * 0.2), // Random speed variation
                ringIndex: 0,
                ringsCollected: 0
            });
            this.scene.add(mesh);
        }
    },

    animate: function() {
        if (!this.isPlaying) return;
        requestAnimationFrame(() => this.animate());

        const dt = Math.min(this.clock.getDelta(), 0.1);
        const Cfg = SKY_CONFIG;

        // --- PLAYER PHYSICS ---
        let targetSpeed = Cfg.NORMAL_SPEED;
        if (this.keys.boost && this.boost > 0) {
            targetSpeed = Cfg.BOOST_SPEED;
            this.boost = Math.max(0, this.boost - (Cfg.BOOST_DRAIN * dt));
        } else {
            this.boost = Math.min(100, this.boost + (Cfg.BOOST_REFILL * dt));
        }
        this.speed = THREE.MathUtils.lerp(this.speed, targetSpeed, dt * 2);

        const moveDist = this.speed * dt;
        const turn = Cfg.TURN_SPEED * dt;

        if (this.keys.left) this.plane.rotateY(turn);
        if (this.keys.right) this.plane.rotateY(-turn);
        if (this.keys.up) this.plane.rotateX(turn);
        if (this.keys.down) this.plane.rotateX(-turn);

        this.plane.translateZ(-moveDist);
        this.pos.copy(this.plane.position);

        // Player Collision
        const h = MapManager.getTerrainHeight(this.pos.x, this.pos.z);
        if (this.pos.y < h + 20) {
            this.plane.position.y = h + 20;
            this.plane.rotateX(-0.1); // Bounce up
            this.health -= Cfg.COLLISION_DAMAGE * dt;
            if (this.health <= 0) this.end(false);
        }

        // --- SMART AI LOGIC ---
        this.enemies.forEach(bot => {
            // 1. Find Target Ring
            const targetRing = this.rings[bot.ringIndex % Cfg.RINGS_PER_LAP];
            if (!targetRing) return;

            // 2. Look at Target
            const targetPos = targetRing.position.clone();
            const lookVector = new THREE.Vector3().subVectors(targetPos, bot.mesh.position).normalize();
            
            // 3. TERRAIN AVOIDANCE (The "Smart" Part)
            // Look ahead 2 seconds
            const lookAheadPos = bot.mesh.position.clone().add(lookVector.multiplyScalar(bot.speed * 2));
            const terrainH = MapManager.getTerrainHeight(lookAheadPos.x, lookAheadPos.z);
            
            // If terrain is higher than bot, FORCE PITCH UP
            const dummy = new THREE.Object3D();
            dummy.position.copy(bot.mesh.position);
            
            if (lookAheadPos.y < terrainH + 150) {
                // Panic Mode: Pitch up immediately, ignore ring for a second
                targetPos.y = terrainH + 500; 
            }
            
            dummy.lookAt(targetPos);
            
            // Smooth Rotation (Slerp)
            bot.mesh.quaternion.slerp(dummy.quaternion, dt * 2.0);
            bot.mesh.translateZ(-bot.speed * dt);

            // AI Ring Collection
            if (bot.mesh.position.distanceTo(targetRing.position) < 100) {
                bot.ringIndex++;
                bot.ringsCollected++;
                if (bot.ringsCollected >= Cfg.TOTAL_RINGS_WIN) {
                    this.end(false, `${bot.name} Won!`);
                }
            }
        });

        // --- PLAYER RING LOGIC ---
        const myNextRing = this.rings[this.ringsCollected % Cfg.RINGS_PER_LAP];
        if (myNextRing && this.pos.distanceTo(myNextRing.position) < 80) {
            if(window.SFXManager) SFXManager.playRing(GameManager.state.isSfxOn);
            myNextRing.visible = false; // Hide temporarily or keep visible based on game style
            this.ringsCollected++;
            if (this.ringsCollected >= Cfg.TOTAL_RINGS_WIN) {
                this.end(true);
            }
        }

        // --- CAMERA & UI ---
        const camOffset = new THREE.Vector3(0, 30, 80).applyQuaternion(this.plane.quaternion);
        this.camera.position.lerp(this.pos.clone().add(camOffset), 0.1);
        this.camera.lookAt(this.pos);

        this.updateHUD();
        this.renderer.render(this.scene, this.camera);
    },

    updateHUD: function() {
        document.getElementById('health-bar').style.width = this.health + '%';
        document.getElementById('boost-bar').style.width = this.boost + '%';
        document.getElementById('score-text').innerText = `${this.ringsCollected}/${SKY_CONFIG.TOTAL_RINGS_WIN}`;

        // Update Leaderboard
        const list = document.getElementById('lb-content');
        let racers = [
            { name: "YOU", score: this.ringsCollected, isMe: true },
            ...this.enemies.map(e => ({ name: e.name, score: e.ringsCollected, isMe: false }))
        ];
        racers.sort((a,b) => b.score - a.score);
        
        list.innerHTML = racers.map((r, i) => `
            <div class="lb-row ${r.isMe ? 'lb-you' : ''}">
                <span>${i+1}. ${r.name}</span>
                <span>${r.score}</span>
            </div>
        `).join('');
    },

    setupInputs: function() {
        const bind = GameManager.state.bindings;
        const handler = (e, val) => {
            const k = e.key.toLowerCase();
            if (k === bind.up) this.keys.up = val;
            if (k === bind.down) this.keys.down = val;
            if (k === bind.left) this.keys.left = val;
            if (k === bind.right) this.keys.right = val;
            if (k === bind.boost) this.keys.boost = val;
        };
        window.addEventListener('keydown', e => handler(e, 1));
        window.addEventListener('keyup', e => handler(e, 0));

        // Touch
        const touch = (id, k) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', e => { e.preventDefault(); this.keys[k]=1; });
            el.addEventListener('touchend', e => { e.preventDefault(); this.keys[k]=0; });
        };
        touch('btn-up','up'); touch('btn-down','down');
        touch('btn-left','left'); touch('btn-right','right'); touch('btn-boost','boost');
    },

    end: function(win, reason) {
        this.isPlaying = false;
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-title').innerText = win ? "VICTORY" : "DEFEAT";
        document.getElementById('end-title').style.color = win ? "#00ff00" : "#ff4444";
        document.getElementById('end-reason').innerText = reason || (win ? "Mission Complete" : "Crashed");
        
        if(window.MusicManager) MusicManager.stop();
    }
};

window.onload = () => Game.init();
</script>
</body>
</html>
